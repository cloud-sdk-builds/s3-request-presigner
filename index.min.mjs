var e=function(){return e=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var i in r=arguments[t])Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i]);return e},e.apply(this,arguments)};function r(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)r.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(t[n[i]]=e[n[i]])}return t}function t(e,r,t,n){return new(t||(t=Promise))(function(i,o){function a(e){try{u(n.next(e))}catch(e){o(e)}}function s(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(a,s)}u((n=n.apply(e,r||[])).next())})}function n(e,r){var t,n,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(u){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(t=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=r.call(e,o)}catch(e){s=[6,e],n=0}finally{t=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function i(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function o(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,i,o=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(i)throw i.error}}return a}function a(e,r,t){if(t||2===arguments.length)for(var n,i=0,o=r.length;i<o;i++)!n&&i in r||(n||(n=Array.prototype.slice.call(r,0,i)),n[i]=r[i]);return e.concat(n||Array.prototype.slice.call(r))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;for(var s={},u={},c=0;c<256;c++){var l=c.toString(16).toLowerCase();1===l.length&&(l="0"+l),s[c]=l,u[l]=c}function h(e){for(var r="",t=0;t<e.byteLength;t++)r+=s[e[t]];return r}var d="X-Amz-Date",f="X-Amz-Signature",p="X-Amz-Security-Token",v="authorization",y=d.toLowerCase(),g=[v,y,"date"],b=f.toLowerCase(),w="x-amz-content-sha256",m=p.toLowerCase(),S={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},A=/^proxy-/,x=/^sec-/,j="AWS4-HMAC-SHA256",O="AWS4-HMAC-SHA256-PAYLOAD",k="aws4_request",q={},C=[];function P(e,r,t){return e+"/"+r+"/"+t+"/"+k}function D(e,r,t){var n=new e(r);return n.update(t),n.digest()}function H(e,r,t){var n,o,a=e.headers,s={};try{for(var u=i(Object.keys(a).sort()),c=u.next();!c.done;c=u.next()){var l=c.value,h=l.toLowerCase();(h in S||(null==r?void 0:r.has(h))||A.test(h)||x.test(h))&&(!t||t&&!t.has(h))||(s[h]=a[l].trim().replace(/\s+/g," "))}}catch(e){n={error:e}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}return s}var E=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,z)},z=function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()};function L(e,r){var o=e.headers,a=e.body;return t(this,void 0,void 0,function(){var e,t,s,u,c,l,d;return n(this,function(n){switch(n.label){case 0:try{for(e=i(Object.keys(o)),t=e.next();!t.done;t=e.next())if((s=t.value).toLowerCase()===w)return[2,o[s]]}catch(e){l={error:e}}finally{try{t&&!t.done&&(d=e.return)&&d.call(e)}finally{if(l)throw l.error}}return null!=a?[3,1]:[2,"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"];case 1:return"string"==typeof a||ArrayBuffer.isView(a)||(f=a,"function"==typeof ArrayBuffer&&f instanceof ArrayBuffer||"[object ArrayBuffer]"===Object.prototype.toString.call(f))?((u=new r).update(a),c=h,[4,u.digest()]):[3,3];case 2:return[2,c.apply(void 0,[n.sent()])];case 3:return[2,"UNSIGNED-PAYLOAD"]}var f})})}function R(t){var n=t.headers,i=t.query,o=r(t,["headers","query"]);return e(e({},o),{headers:e({},n),query:i?I(i):void 0})}function I(r){return Object.keys(r).reduce(function(t,n){var i,s=r[n];return e(e({},t),((i={})[n]=Array.isArray(s)?a([],o(s),!1):s,i))},{})}function T(e){var r,t;e="function"==typeof e.clone?e.clone():R(e);try{for(var n=i(Object.keys(e.headers)),o=n.next();!o.done;o=n.next()){var a=o.value;g.indexOf(a.toLowerCase())>-1&&delete e.headers[a]}}catch(e){r={error:e}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(r)throw r.error}}return e}var K=function(){function r(e){var r=e.applyChecksum,t=e.credentials,n=e.region,i=e.service,o=e.sha256,a=e.uriEscapePath,s=void 0===a||a;this.service=i,this.sha256=o,this.uriEscapePath=s,this.applyChecksum="boolean"!=typeof r||r,this.regionProvider=U(n),this.credentialProvider=M(t)}return r.prototype.presign=function(r,o){return void 0===o&&(o={}),t(this,void 0,void 0,function(){var t,a,s,u,c,l,h,v,y,g,b,w,m,S,A,x,O,k,q,C,D,E,z,I;return n(this,function(n){switch(n.label){case 0:return t=o.signingDate,a=void 0===t?new Date:t,s=o.expiresIn,u=void 0===s?3600:s,c=o.unsignableHeaders,l=o.unhoistableHeaders,h=o.signableHeaders,v=o.signingRegion,y=o.signingService,[4,this.credentialProvider()];case 1:return g=n.sent(),null==v?[3,2]:(w=v,[3,4]);case 2:return[4,this.regionProvider()];case 3:w=n.sent(),n.label=4;case 4:return b=w,m=X(a),S=m.longDate,A=m.shortDate,u>604800?[2,Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future")]:(x=P(A,b,null!=y?y:this.service),O=function(r,t){var n,o,a;void 0===t&&(t={});var s="function"==typeof r.clone?r.clone():R(r),u=s.headers,c=s.query,l=void 0===c?{}:c;try{for(var h=i(Object.keys(u)),d=h.next();!d.done;d=h.next()){var f=d.value,p=f.toLowerCase();"x-amz-"!==p.substr(0,6)||(null===(a=t.unhoistableHeaders)||void 0===a?void 0:a.has(p))||(l[f]=u[f],delete u[f])}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=h.return)&&o.call(h)}finally{if(n)throw n.error}}return e(e({},r),{headers:u,query:l})}(T(r),{unhoistableHeaders:l}),g.sessionToken&&(O.query[p]=g.sessionToken),O.query["X-Amz-Algorithm"]=j,O.query["X-Amz-Credential"]=g.accessKeyId+"/"+x,O.query[d]=S,O.query["X-Amz-Expires"]=u.toString(10),k=H(O,c,h),O.query["X-Amz-SignedHeaders"]=N(k),q=O.query,C=f,D=this.getSignature,E=[S,x,this.getSigningKey(g,b,A,y)],z=this.createCanonicalRequest,I=[O,k],[4,L(r,this.sha256)]);case 5:return[4,D.apply(this,E.concat([z.apply(this,I.concat([n.sent()]))]))];case 6:return q[C]=n.sent(),[2,O]}})})},r.prototype.sign=function(e,r){return t(this,void 0,void 0,function(){return n(this,function(t){return"string"==typeof e?[2,this.signString(e,r)]:e.headers&&e.payload?[2,this.signEvent(e,r)]:[2,this.signRequest(e,r)]})})},r.prototype.signEvent=function(e,r){var i=e.headers,o=e.payload,a=r.signingDate,s=void 0===a?new Date:a,u=r.priorSignature,c=r.signingRegion,l=r.signingService;return t(this,void 0,void 0,function(){var e,r,t,a,d,f,p,v,y,g,b;return n(this,function(n){switch(n.label){case 0:return null==c?[3,1]:(r=c,[3,3]);case 1:return[4,this.regionProvider()];case 2:r=n.sent(),n.label=3;case 3:return e=r,t=X(s),a=t.shortDate,d=t.longDate,f=P(a,e,null!=l?l:this.service),[4,L({headers:{},body:o},this.sha256)];case 4:return p=n.sent(),(v=new this.sha256).update(i),g=h,[4,v.digest()];case 5:return y=g.apply(void 0,[n.sent()]),b=[O,d,f,u,y,p].join("\n"),[2,this.signString(b,{signingDate:s,signingRegion:e,signingService:l})]}})})},r.prototype.signString=function(e,r){var i=void 0===r?{}:r,o=i.signingDate,a=void 0===o?new Date:o,s=i.signingRegion,u=i.signingService;return t(this,void 0,void 0,function(){var r,t,i,o,c,l,d,f;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return r=n.sent(),null==s?[3,2]:(i=s,[3,4]);case 2:return[4,this.regionProvider()];case 3:i=n.sent(),n.label=4;case 4:return t=i,o=X(a).shortDate,d=(l=this.sha256).bind,[4,this.getSigningKey(r,t,o,u)];case 5:return(c=new(d.apply(l,[void 0,n.sent()]))).update(e),f=h,[4,c.digest()];case 6:return[2,f.apply(void 0,[n.sent()])]}})})},r.prototype.signRequest=function(e,r){var o=void 0===r?{}:r,a=o.signingDate,s=void 0===a?new Date:a,u=o.signableHeaders,c=o.unsignableHeaders,l=o.signingRegion,h=o.signingService;return t(this,void 0,void 0,function(){var r,t,o,a,d,f,p,g,b,S,A;return n(this,function(n){switch(n.label){case 0:return[4,this.credentialProvider()];case 1:return r=n.sent(),null==l?[3,2]:(o=l,[3,4]);case 2:return[4,this.regionProvider()];case 3:o=n.sent(),n.label=4;case 4:return t=o,a=T(e),d=X(s),f=d.longDate,p=d.shortDate,g=P(p,t,null!=h?h:this.service),a.headers[y]=f,r.sessionToken&&(a.headers[m]=r.sessionToken),[4,L(a,this.sha256)];case 5:return b=n.sent(),!function(e,r){var t,n;e=e.toLowerCase();try{for(var o=i(Object.keys(r)),a=o.next();!a.done;a=o.next())if(e===a.value.toLowerCase())return!0}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!1}(w,a.headers)&&this.applyChecksum&&(a.headers[w]=b),S=H(a,c,u),[4,this.getSignature(f,g,this.getSigningKey(r,t,p,h),this.createCanonicalRequest(a,S,b))];case 6:return A=n.sent(),a.headers[v]=j+" Credential="+r.accessKeyId+"/"+g+", SignedHeaders="+N(S)+", Signature="+A,[2,a]}})})},r.prototype.createCanonicalRequest=function(e,r,t){var n=Object.keys(r).sort();return e.method+"\n"+this.getCanonicalPath(e)+"\n"+function(e){var r,t,n=e.query,o=void 0===n?{}:n,a=[],s={},u=function(e){if(e.toLowerCase()===b)return"continue";a.push(e);var r=o[e];"string"==typeof r?s[e]=E(e)+"="+E(r):Array.isArray(r)&&(s[e]=r.slice(0).sort().reduce(function(r,t){return r.concat([E(e)+"="+E(t)])},[]).join("&"))};try{for(var c=i(Object.keys(o).sort()),l=c.next();!l.done;l=c.next())u(l.value)}catch(e){r={error:e}}finally{try{l&&!l.done&&(t=c.return)&&t.call(c)}finally{if(r)throw r.error}}return a.map(function(e){return s[e]}).filter(function(e){return e}).join("&")}(e)+"\n"+n.map(function(e){return e+":"+r[e]}).join("\n")+"\n\n"+n.join(";")+"\n"+t},r.prototype.createStringToSign=function(e,r,i){return t(this,void 0,void 0,function(){var t,o;return n(this,function(n){switch(n.label){case 0:return(t=new this.sha256).update(i),[4,t.digest()];case 1:return o=n.sent(),[2,j+"\n"+e+"\n"+r+"\n"+h(o)]}})})},r.prototype.getCanonicalPath=function(e){var r=e.path;return this.uriEscapePath?"/"+encodeURIComponent(r.replace(/^\//,"")).replace(/%2F/g,"/"):r},r.prototype.getSignature=function(e,r,i,o){return t(this,void 0,void 0,function(){var t,a,s,u,c;return n(this,function(n){switch(n.label){case 0:return[4,this.createStringToSign(e,r,o)];case 1:return t=n.sent(),u=(s=this.sha256).bind,[4,i];case 2:return(a=new(u.apply(s,[void 0,n.sent()]))).update(t),c=h,[4,a.digest()];case 3:return[2,c.apply(void 0,[n.sent()])]}})})},r.prototype.getSigningKey=function(e,r,o,a){return function(e,r,o,a,s){return t(void 0,void 0,void 0,function(){var t,u,c,l,d,f,p,v,y;return n(this,function(n){switch(n.label){case 0:return[4,D(e,r.secretAccessKey,r.accessKeyId)];case 1:if(t=n.sent(),(u=o+":"+a+":"+s+":"+h(t)+":"+r.sessionToken)in q)return[2,q[u]];for(C.push(u);C.length>50;)delete q[C.shift()];c="AWS4"+r.secretAccessKey,n.label=2;case 2:n.trys.push([2,7,8,9]),l=i([o,a,s,k]),d=l.next(),n.label=3;case 3:return d.done?[3,6]:(f=d.value,[4,D(e,c,f)]);case 4:c=n.sent(),n.label=5;case 5:return d=l.next(),[3,3];case 6:return[3,9];case 7:return p=n.sent(),v={error:p},[3,9];case 8:try{d&&!d.done&&(y=l.return)&&y.call(l)}finally{if(v)throw v.error}return[7];case 9:return[2,q[u]=c]}})})}(this.sha256,e,o,r,a||this.service)},r}(),X=function(e){var r,t=(r=e,function(e){return"number"==typeof e?new Date(1e3*e):"string"==typeof e?Number(e)?new Date(1e3*Number(e)):new Date(e):e}(r).toISOString().replace(/\.\d{3}Z$/,"Z")).replace(/[\-:]/g,"");return{longDate:t,shortDate:t.substr(0,8)}},N=function(e){return Object.keys(e).sort().join(";")},U=function(e){if("string"==typeof e){var r=Promise.resolve(e);return function(){return r}}return e},M=function(e){if("object"==typeof e){var r=Promise.resolve(e);return function(){return r}}return e},B=function(){function i(r){var t=e({service:r.signingName||r.service||"s3",uriEscapePath:r.uriEscapePath||!1},r);this.signer=new K(t)}return i.prototype.presign=function(i,o){void 0===o&&(o={});var a=o.unsignableHeaders,s=void 0===a?new Set:a,u=o.unhoistableHeaders,c=void 0===u?new Set:u,l=r(o,["unsignableHeaders","unhoistableHeaders"]);return t(this,void 0,void 0,function(){return n(this,function(r){return s.add("content-type"),Object.keys(i.headers).map(function(e){return e.toLowerCase()}).filter(function(e){return e.startsWith("x-amz-server-side-encryption")}).forEach(function(e){c.add(e)}),i.headers["X-Amz-Content-Sha256"]="UNSIGNED-PAYLOAD",i.headers.host||(i.headers.host=i.hostname,i.port&&(i.headers.host=i.headers.host+":"+i.port)),[2,this.signer.presign(i,e({expiresIn:900,unsignableHeaders:s,unhoistableHeaders:c},l))]})})},i}(),G=function(){function r(e){this.method=e.method||"GET",this.hostname=e.hostname||"localhost",this.port=e.port,this.query=e.query||{},this.headers=e.headers||{},this.body=e.body,this.protocol=e.protocol?":"!==e.protocol.substr(-1)?e.protocol+":":e.protocol:"https:",this.path=e.path?"/"!==e.path.charAt(0)?"/"+e.path:e.path:"/"}return r.isInstance=function(e){if(!e)return!1;var r=e;return"method"in r&&"protocol"in r&&"hostname"in r&&"path"in r&&"object"==typeof r.query&&"object"==typeof r.headers},r.prototype.clone=function(){var t,n=new r(e(e({},this),{headers:e({},this.headers)}));return n.query&&(n.query=(t=n.query,Object.keys(t).reduce(function(r,n){var i,s=t[n];return e(e({},r),((i={})[n]=Array.isArray(s)?a([],o(s),!1):s,i))},{}))),n},r}();function W(e){var r=e.port,t=e.query,n=e.protocol,o=e.path,a=e.hostname;n&&":"!==n.substr(-1)&&(n+=":"),r&&(a+=":"+r),o&&"/"!==o.charAt(0)&&(o="/"+o);var s=t?function(e){var r,t,n=[];try{for(var o=i(Object.keys(e).sort()),a=o.next();!a.done;a=o.next()){var s=a.value,u=e[s];if(s=E(s),Array.isArray(u))for(var c=0,l=u.length;c<l;c++)n.push(s+"="+E(u[c]));else{var h=s;(u||"string"==typeof u)&&(h+="="+E(u)),n.push(h)}}}catch(e){r={error:e}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(r)throw r.error}}return n.join("&")}(t):"";return s&&"?"!==s[0]&&(s="?"+s),n+"//"+a+o+s}var Y=function(r,i,o){return void 0===o&&(o={}),t(void 0,void 0,void 0,function(){var a,s,u,c,l;return n(this,function(h){switch(h.label){case 0:a=new B(e({},r.config)),s=function(r,i){return function(r){return t(void 0,void 0,void 0,function(){var t,s,u;return n(this,function(n){switch(n.label){case 0:if(t=r.request,!G.isInstance(t))throw new Error("Request to be presigned is not an valid HTTP request.");return delete t.headers["amz-sdk-invocation-id"],delete t.headers["amz-sdk-request"],delete t.headers["x-amz-user-agent"],[4,a.presign(t,e(e({},o),{signingRegion:null!==(s=o.signingRegion)&&void 0!==s?s:i.signing_region,signingService:null!==(u=o.signingService)&&void 0!==u?u:i.signing_service}))];case 1:return[2,{response:{},output:{$metadata:{httpStatusCode:200},presigned:n.sent()}}]}})})}},u="presignInterceptMiddleware",r.middlewareStack.addRelativeTo(s,{name:u,relation:"before",toMiddleware:"awsAuthMiddleware",override:!0}),h.label=1;case 1:return h.trys.push([1,,3,4]),[4,r.send(i)];case 2:return l=h.sent(),c=l.presigned,[3,4];case 3:return r.middlewareStack.remove(u),[7];case 4:return[2,W(c)]}})})};export{B as S3RequestPresigner,Y as getSignedUrl};